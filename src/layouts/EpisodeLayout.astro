---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import TagList from '../components/content/TagList.astro';
import CopyCodeButton from '../components/ui/CopyCodeButton.astro';
import HeadingAnchor from '../components/ui/HeadingAnchor.astro';
import MermaidRenderer from '../components/ui/MermaidRenderer.astro';
import Utterances from '../components/ui/Utterances.astro';
import YouTube from '../components/embeds/YouTube.astro';
import Spotify from '../components/embeds/Spotify.astro';
import AppleMusic from '../components/embeds/AppleMusic.astro';
import { formatDate } from '../utils/formatDate';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  episodeNumber: number;
  youtubeId?: string;
  spotifyUrl?: string;
  appleMusicUrl?: string;
  tags: string[];
  ogImage?: string;
}

const { title, description, pubDate, episodeNumber, youtubeId, spotifyUrl, appleMusicUrl, tags, ogImage } = Astro.props;
---

<BaseLayout title={`Episode ${episodeNumber}: ${title}`} description={description} image={ogImage}>
  <Header />
  <main class="flex-grow">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
      <article>
        <header class="mb-8 pb-6">
        <div class="text-terminal-greenDim text-sm mb-2">
          EPISODE {episodeNumber.toString().padStart(3, '0')}
        </div>
        <h1 class="text-3xl font-bold text-terminal-green mb-4">
          {title}
        </h1>
        <div class="flex flex-wrap items-center gap-4 text-terminal-greenDim text-sm mb-4">
          <time datetime={pubDate.toISOString()}>
            {formatDate(pubDate)}
          </time>
        </div>
        {tags.length > 0 && (
          <div class="mt-4">
            <TagList tags={tags} linkable={true} />
          </div>
        )}
        </header>
      </article>
    </div>

    <div class="border-t border-terminal-greenDim">
      <div class="container mx-auto px-4 py-8 max-w-5xl">
        <article>

      <!-- Video Embed -->
      {youtubeId && (
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-terminal-green mb-4">Watch</h2>
          <YouTube videoId={youtubeId} title={title} />
        </div>
      )}

      <!-- Podcast Players -->
      {(spotifyUrl || appleMusicUrl) && (
        <div class="mb-8">
          <h2 class="text-2xl font-bold text-terminal-green mb-4">Listen</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {spotifyUrl && (
              <div>
                <h3 class="text-lg text-terminal-greenDim mb-2">Spotify</h3>
                <Spotify url={spotifyUrl} />
              </div>
            )}
            {appleMusicUrl && (
              <div>
                <h3 class="text-lg text-terminal-greenDim mb-2">Apple Music</h3>
                <AppleMusic url={appleMusicUrl} />
              </div>
            )}
          </div>
        </div>
      )}

      <!-- Show Notes -->
      <div class="prose prose-invert max-w-none">
        <h2 class="text-2xl font-bold text-terminal-green mb-4">Show Notes</h2>
        <div class="prose-content">
            <slot />
          </div>
        <Utterances />
        </article>
      </div>
    </div>
  </main>
  <Footer />
  <CopyCodeButton />
  <HeadingAnchor />
  <MermaidRenderer />
</BaseLayout>

<style>
  .prose-content :global(h2),
  .prose-content :global(h3),
  .prose-content :global(h4) {
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .prose-content :global(p) {
    margin-bottom: 1rem;
    line-height: 1.7;
  }

  .prose-content :global(a) {
    text-decoration: underline;
  }

  .prose-content :global(ul),
  .prose-content :global(ol) {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
  }
</style>
