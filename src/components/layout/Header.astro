---
import Navigation from './Navigation.astro';

const currentPath = Astro.url.pathname;
const base = import.meta.env.BASE_URL;
---

<header class="border-b border-terminal-greenDim bg-terminal-black sticky top-0 z-50">
  <div class="container mx-auto px-4 py-4">
    <div class="flex items-center justify-between gap-4">
      <!-- Logo/Brand -->
      <a href={`${base}/`} class="flex items-center space-x-2 no-underline hover:no-underline flex-shrink-0">
        <span class="text-terminal-green text-2xl font-bold">></span>
        <span class="text-terminal-green text-xl font-bold">
          The Copilot Stack
        </span>
        <span class="text-terminal-green text-2xl animate-pulse">_</span>
      </a>

      <!-- Search (Desktop) -->
      <div class="flex-grow max-w-md hidden md:block relative">
        <div id="header-search"></div>
        <kbd class="search-kbd-hint">
          <span class="search-kbd-key" id="kbd-modifier">âŒ˜</span>K
        </kbd>
      </div>

      <!-- Navigation -->
      <Navigation currentPath={currentPath} />

      <!-- Mobile Search Button -->
      <button
        id="mobile-search-toggle"
        class="md:hidden text-terminal-green hover:text-terminal-greenDim transition-colors"
        aria-label="Toggle search"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </button>
    </div>

    <!-- Mobile Search (Hidden by default) -->
    <div id="mobile-search" class="hidden md:hidden mt-4 pb-2"></div>
  </div>
</header>

<link href={`${base}/pagefind/pagefind-ui.css`} rel="stylesheet" is:inline />
<script src={`${base}/pagefind/pagefind-ui.js`} is:inline></script>

<script>
  // Detect OS for keyboard shortcut display
  function detectOS() {
    const platform = navigator.platform.toLowerCase();
    const userAgent = navigator.userAgent.toLowerCase();
    return platform.includes('mac') || userAgent.includes('mac') ? 'mac' : 'other';
  }

  // Update keyboard shortcut hint based on OS
  const isMac = detectOS() === 'mac';
  const kbdModifier = document.getElementById('kbd-modifier');
  if (kbdModifier && !isMac) {
    kbdModifier.textContent = 'Ctrl';
  }

  // Initialize search
  function initializeSearch() {
    if (typeof window === 'undefined' || !(window as any).PagefindUI) {
      return;
    }

    // Desktop search
    const desktopSearch = document.getElementById('header-search');
    if (desktopSearch && !desktopSearch.hasAttribute('data-initialized')) {
      desktopSearch.setAttribute('data-initialized', 'true');
      new (window as any).PagefindUI({
        element: '#header-search',
        showSubResults: true,
        showImages: false,
        excerptLength: 20,
        resetStyles: false,
        translations: {
          placeholder: 'Search...',
          zero_results: 'No results found for [SEARCH_TERM]',
        },
        debounceTimeoutMs: 300,
      });
    }

    // Mobile search
    const mobileSearch = document.getElementById('mobile-search');
    if (mobileSearch && !mobileSearch.hasAttribute('data-initialized')) {
      mobileSearch.setAttribute('data-initialized', 'true');
      new (window as any).PagefindUI({
        element: '#mobile-search',
        showSubResults: true,
        showImages: false,
        excerptLength: 20,
        resetStyles: false,
        translations: {
          placeholder: 'Search...',
          zero_results: 'No results found for [SEARCH_TERM]',
        },
        debounceTimeoutMs: 300,
      });
    }

    // Mobile search toggle
    const mobileSearchToggle = document.getElementById('mobile-search-toggle');
    mobileSearchToggle?.addEventListener('click', (e) => {
      e.stopPropagation();
      mobileSearch?.classList.toggle('hidden');
      if (!mobileSearch?.classList.contains('hidden')) {
        const input = mobileSearch?.querySelector('input') as HTMLInputElement;
        input?.focus();
      }
    });

    // Close mobile search when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (
        mobileSearch &&
        !mobileSearch.contains(target) &&
        !mobileSearchToggle?.contains(target) &&
        !mobileSearch.classList.contains('hidden')
      ) {
        mobileSearch.classList.add('hidden');
      }
    });

    // Close mobile search with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && mobileSearch && !mobileSearch.classList.contains('hidden')) {
        mobileSearch.classList.add('hidden');
      }
    });

    // Global keyboard shortcut (Cmd/Ctrl + K)
    document.addEventListener('keydown', (e) => {
      const isCmdOrCtrl = isMac ? e.metaKey : e.ctrlKey;
      if (isCmdOrCtrl && e.key === 'k') {
        e.preventDefault();

        // On mobile, open the mobile search
        if (window.innerWidth < 768) {
          mobileSearch?.classList.remove('hidden');
          const mobileInput = mobileSearch?.querySelector('input') as HTMLInputElement;
          mobileInput?.focus();
        } else {
          // On desktop, focus the desktop search
          const desktopInput = desktopSearch?.querySelector('input') as HTMLInputElement;
          desktopInput?.focus();
        }
      }
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSearch);
  } else {
    initializeSearch();
  }

  // Reinitialize after view transitions (if enabled in future)
  document.addEventListener('astro:page-load', initializeSearch);
</script>

<style is:global>
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0;
    }
  }

  .animate-pulse {
    animation: pulse 1s ease-in-out infinite;
  }
</style>
