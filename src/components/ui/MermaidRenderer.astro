---
// Client-side Mermaid renderer
// This component initializes Mermaid and renders all mermaid code blocks
---

<script>
  import mermaid from 'mermaid';

  // Initialize Mermaid with terminal theme
  mermaid.initialize({
    startOnLoad: false,
    theme: 'dark',
    themeVariables: {
      primaryColor: '#00FF00',
      primaryTextColor: '#00FF00',
      primaryBorderColor: '#00AA00',
      lineColor: '#00AA00',
      secondaryColor: '#1a1a1a',
      tertiaryColor: '#0a0a0a',
      background: '#0a0a0a',
      mainBkg: '#1a1a1a',
      secondBkg: '#0a0a0a',
      textColor: '#00FF00',
      border1: '#00AA00',
      border2: '#00AA00',
    },
    flowchart: {
      htmlLabels: true,
      curve: 'basis',
    },
  });

  let initialized = false;

  async function renderMermaidDiagrams() {
    // Prevent multiple initializations
    if (initialized) return;

    // Find all code blocks with mermaid language (both Shiki and standard patterns)
    const mermaidBlocks = document.querySelectorAll(
      'pre[data-language="mermaid"], pre code.language-mermaid'
    );

    if (mermaidBlocks.length === 0) return;

    initialized = true;

    for (const block of mermaidBlocks) {
      try {
        // Handle both <pre> and <code> elements
        const isPreElement = block.tagName === 'PRE';
        const codeElement = isPreElement ? block.querySelector('code') : block;
        const code = codeElement?.textContent || '';
        const pre = isPreElement ? block : block.closest('pre');

        if (!pre || !code.trim()) continue;

        // Create a div for mermaid to render into
        const container = document.createElement('div');
        container.className = 'mermaid-diagram';
        container.style.cssText = `
          padding: 2rem;
          background: var(--terminal-gray);
          border: 1px solid var(--terminal-greenDim);
          border-radius: 0.5rem;
          margin: 2rem 0;
          overflow-x: auto;
        `;

        // Generate unique ID for this diagram
        const id = `mermaid-${Math.random().toString(36).substring(7)}`;

        // Render the diagram
        const { svg } = await mermaid.render(id, code);
        container.innerHTML = svg;

        // Replace the pre element with the rendered diagram
        pre.replaceWith(container);
      } catch (error) {
        console.error('Failed to render Mermaid diagram:', error);
        // Add visual error indicator
        if (pre) {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'mermaid-error';
          errorDiv.style.cssText = `
            padding: 1rem;
            background: var(--terminal-gray);
            border: 1px solid #ff4444;
            border-radius: 0.5rem;
            color: #ff6666;
            font-family: 'JetBrains Mono', monospace;
            margin: 2rem 0;
          `;
          errorDiv.textContent = `Failed to render diagram: ${error.message}`;
          pre.replaceWith(errorDiv);
        }
      }
    }
  }

  // Run on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', renderMermaidDiagrams);
  } else {
    renderMermaidDiagrams();
  }

  // Run after view transitions (reset initialized flag)
  document.addEventListener('astro:page-load', () => {
    initialized = false;
    renderMermaidDiagrams();
  });
</script>

<style is:global>
  .mermaid-diagram svg {
    max-width: 100%;
    height: auto;
  }

  .mermaid-diagram .node rect,
  .mermaid-diagram .node circle,
  .mermaid-diagram .node ellipse,
  .mermaid-diagram .node polygon {
    fill: var(--terminal-gray) !important;
    stroke: var(--terminal-green) !important;
    stroke-width: 2px;
  }

  .mermaid-diagram .node .label {
    color: var(--terminal-green) !important;
    fill: var(--terminal-green) !important;
  }

  .mermaid-diagram .edgePath .path {
    stroke: var(--terminal-greenDim) !important;
    stroke-width: 2px;
  }

  .mermaid-diagram .edgeLabel {
    background-color: var(--terminal-black) !important;
    color: var(--terminal-greenDim) !important;
  }

  .mermaid-diagram .cluster rect {
    fill: var(--terminal-black) !important;
    stroke: var(--terminal-greenDim) !important;
    stroke-width: 1px;
  }

  .mermaid-diagram text {
    fill: var(--terminal-green) !important;
    font-family: 'JetBrains Mono', monospace !important;
  }
</style>
